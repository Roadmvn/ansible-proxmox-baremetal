---
# ============================================
# PLAYBOOK: CREATION CLUSTER PROXMOX VE
# ============================================
# Création automatisée d'un cluster Proxmox VE
# Architecture refactorisée en 6 phases logiques
#
# Utilisation:
#   ansible-playbook -i inventory/proxmox-cluster.ini playbooks/create-proxmox-cluster.yml
#
# Ou via Makefile:
#   make create-cluster
#
# Prérequis:
#   - Proxmox VE installé sur tous les nœuds
#   - Vault configuré avec credentials (voir group_vars/proxmox_cluster/README.md)
#   - Inventaire configuré (inventory/proxmox-cluster.ini)
# ============================================

# ============================================
# PHASE 1: PREPARATION - CONFIGURATION SSH INITIALE
# ============================================
# Configure SSH pour l'authentification par clé
# Utilise le mot de passe root pour la connexion initiale
# ============================================

- name: "Phase 1: Préparation - Configuration SSH initiale"
  hosts: proxmox_cluster
  gather_facts: true
  vars:
    # Utiliser le mot de passe pour la connexion initiale
    # Défini dans l'inventaire par serveur si différents
    # Ou passer avec: -e "ansible_password=votremdp"
    # Désactiver temporairement la vérification de clé
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
    # La clé SSH sera lue automatiquement depuis ~/.ssh/id_ed25519.pub
    ansible_control_ssh_key: ""

  pre_tasks:
    - name: Afficher le début de la phase 1
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "PHASE 1: PREPARATION SSH"
          - "============================================"
          - "Configuration de l'authentification par clé SSH"
          - "Serveur: {{ inventory_hostname }} ({{ ansible_host }})"
          - "============================================"

    - name: Vérifier la connectivité de base
      ansible.builtin.ping:
      register: ping_result
      failed_when: false

    - name: Échec si le serveur n'est pas accessible
      ansible.builtin.fail:
        msg: "Impossible de contacter {{ inventory_hostname }}. Vérifiez l'IP et les credentials."
      when: ping_result.failed | default(false)

  roles:
    - role: proxmox-ssh-setup

  post_tasks:
    - name: Test de connexion SSH par clé
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: 10
      delegate_to: localhost
      become: false

    - name: Phase 1 terminée
      ansible.builtin.debug:
        msg:
          - "✓ Phase 1 terminée avec succès"
          - "SSH configuré sur {{ inventory_hostname }}"

# ============================================
# PHASE 2: VERIFICATIONS PREALABLES
# ============================================
# Vérifie que tous les prérequis sont remplis
# avant de créer le cluster
# ============================================

- name: "Phase 2: Vérifications préalables"
  hosts: proxmox_cluster
  gather_facts: true

  tasks:
    - name: Afficher le début de la phase 2
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "PHASE 2: VERIFICATIONS PREALABLES"
          - "============================================"

    - name: Vérifier que Proxmox VE est installé
      ansible.builtin.command: pveversion
      register: pve_version_check
      changed_when: false
      failed_when: pve_version_check.rc != 0

    - name: Afficher la version Proxmox VE détectée
      ansible.builtin.debug:
        msg: "Proxmox VE version: {{ pve_version_check.stdout }}"

    - name: Vérifier que le service pve-cluster existe
      ansible.builtin.systemd:
        name: pve-cluster
      register: pve_cluster_service
      check_mode: true

    - name: Vérifier la connectivité réseau entre les nœuds
      ansible.builtin.wait_for:
        host: "{{ hostvars[item]['ansible_host'] }}"
        port: 22
        timeout: 10
      loop: "{{ groups['proxmox_cluster'] }}"
      when:
        - verify_network_connectivity | default(true)
        - item != inventory_hostname
      delegate_to: localhost
      become: false

    - name: Vérifier si un cluster existe déjà sur ce nœud
      ansible.builtin.stat:
        path: /etc/pve/corosync.conf
      register: existing_cluster_config

    - name: Afficher avertissement si cluster existe déjà
      ansible.builtin.debug:
        msg: "ATTENTION: Un cluster existe déjà sur {{ inventory_hostname }}"
      when: existing_cluster_config.stat.exists

    - name: Arrêter si cluster existe déjà
      ansible.builtin.fail:
        msg: |
          Un cluster existe déjà sur {{ inventory_hostname }}.
          Pour recréer le cluster, exécutez d'abord: make destroy-cluster
      when:
        - existing_cluster_config.stat.exists
        - not (force_cluster_recreation | default(false))

    - name: Phase 2 terminée
      ansible.builtin.debug:
        msg: "✓ Phase 2 terminée - Tous les prérequis sont OK"

# ============================================
# PHASE 3: CREATION DU CLUSTER (NŒUD PRIMAIRE)
# ============================================
# Crée le cluster sur le nœud primaire
# ============================================

- name: "Phase 3: Création du cluster (nœud primaire)"
  hosts: proxmox_cluster_primary
  gather_facts: false
  serial: 1

  tasks:
    - name: Afficher le début de la phase 3
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "PHASE 3: CREATION DU CLUSTER"
          - "============================================"
          - "Nœud primaire: {{ inventory_hostname }}"
          - "Nom du cluster: {{ cluster_name }}"
          - "============================================"

    - name: Créer le cluster avec pvecm
      ansible.builtin.command: >
        pvecm create {{ cluster_name }}
        {% if cluster_network %} --link0 {{ cluster_network }}{% endif %}
      register: cluster_creation
      changed_when: cluster_creation.rc == 0
      failed_when:
        - cluster_creation.rc != 0
        - '"already part of a cluster" not in cluster_creation.stderr'

    - name: Attendre que le cluster filesystem soit prêt
      ansible.builtin.wait_for:
        path: /etc/pve/corosync.conf
        timeout: "{{ cluster_verification_timeout }}"

    - name: Redémarrer le service Corosync
      ansible.builtin.systemd:
        name: corosync
        state: restarted
        enabled: true

    - name: Attendre que Corosync soit prêt
      ansible.builtin.pause:
        seconds: 5

    - name: Vérifier la création du cluster
      ansible.builtin.command: pvecm status
      register: cluster_status_primary
      changed_when: false
      retries: 6
      delay: 5
      until: cluster_status_primary.rc == 0

    - name: Afficher le statut du cluster créé
      ansible.builtin.debug:
        msg: "{{ cluster_status_primary.stdout_lines }}"

    - name: Attendre que les services cluster soient stables
      ansible.builtin.pause:
        seconds: 10
        prompt: "Attente de la stabilisation du cluster primaire"

    - name: Phase 3 terminée
      ansible.builtin.debug:
        msg: "✓ Phase 3 terminée - Cluster créé sur {{ inventory_hostname }}"

# ============================================
# PHASE 4: JONCTION AU CLUSTER (NŒUDS SECONDAIRES)
# ============================================
# Joint les nœuds secondaires au cluster
# ============================================

- name: "Phase 4: Jonction au cluster (nœuds secondaires)"
  hosts: proxmox_cluster_nodes
  gather_facts: false
  serial: 1

  tasks:
    - name: Afficher le début de la phase 4
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "PHASE 4: JONCTION AU CLUSTER"
          - "============================================"
          - "Nœud secondaire: {{ inventory_hostname }}"
          - "============================================"

    - name: Obtenir l'IP du nœud primaire
      ansible.builtin.set_fact:
        primary_node_ip: "{{ hostvars[groups['proxmox_cluster_primary'][0]]['ansible_host'] }}"

    - name: Afficher le nœud primaire à rejoindre
      ansible.builtin.debug:
        msg: "Jonction au cluster via le nœud primaire: {{ primary_node_ip }}"

    - name: Joindre le cluster avec pvecm add
      ansible.builtin.command: >
        pvecm add {{ primary_node_ip }}
        --use_ssh
      register: cluster_join
      changed_when: cluster_join.rc == 0
      failed_when:
        - cluster_join.rc != 0
        - '"already part of a cluster" not in cluster_join.stderr'
      timeout: "{{ cluster_join_timeout }}"

    - name: Attendre que la configuration cluster soit synchronisée
      ansible.builtin.wait_for:
        path: /etc/pve/corosync.conf
        timeout: "{{ cluster_verification_timeout }}"

    - name: Vérifier la jonction au cluster
      ansible.builtin.command: pvecm status
      register: cluster_status_node
      changed_when: false
      failed_when: cluster_status_node.rc != 0
      retries: 3
      delay: 5
      until: cluster_status_node.rc == 0

    - name: Afficher le statut du cluster après jonction
      ansible.builtin.debug:
        msg: "{{ cluster_status_node.stdout_lines }}"

    - name: Phase 4 terminée pour ce nœud
      ansible.builtin.debug:
        msg: "✓ Phase 4 terminée - {{ inventory_hostname }} a rejoint le cluster"

# ============================================
# PHASE 5: RECONFIGURATION SSH POST-CLUSTER
# ============================================
# Reconfigure SSH après la création du cluster
# car Proxmox crée un symlink /root/.ssh -> /etc/pve/priv/
# ============================================

- name: "Phase 5: Reconfiguration SSH post-cluster"
  hosts: proxmox_cluster
  gather_facts: false

  tasks:
    - name: Afficher le début de la phase 5
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "PHASE 5: RECONFIGURATION SSH POST-CLUSTER"
          - "============================================"

  roles:
    - role: proxmox-ssh-setup

  post_tasks:
    - name: Phase 5 terminée
      ansible.builtin.debug:
        msg: "✓ Phase 5 terminée - SSH reconfiguré pour le mode cluster"

# ============================================
# PHASE 6: VERIFICATIONS FINALES
# ============================================
# Vérifie que le cluster est opérationnel
# ============================================

- name: "Phase 6: Vérifications finales et résumé"
  hosts: proxmox_cluster
  gather_facts: false

  tasks:
    - name: Afficher le début de la phase 6
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "PHASE 6: VERIFICATIONS FINALES"
          - "============================================"

    - name: Vérifier le statut du cluster
      ansible.builtin.command: pvecm status
      register: final_cluster_status
      changed_when: false

    - name: Vérifier la liste des nœuds du cluster
      ansible.builtin.command: pvecm nodes
      register: cluster_nodes_list
      changed_when: false

    - name: Vérifier le statut de corosync
      ansible.builtin.command: corosync-cfgtool -s
      register: corosync_status
      changed_when: false

    - name: Afficher les informations du cluster
      ansible.builtin.debug:
        msg:
          - "=== STATUT DU CLUSTER ==="
          - "{{ final_cluster_status.stdout_lines }}"
          - "=== NŒUDS DU CLUSTER ==="
          - "{{ cluster_nodes_list.stdout_lines }}"
          - "=== STATUT COROSYNC ==="
          - "{{ corosync_status.stdout_lines }}"

    - name: Vérifier que le quorum est atteint
      ansible.builtin.command: pvecm status
      register: quorum_check
      changed_when: false
      failed_when: quorum_check.stdout is not search('Quorate:\s+Yes')

    - name: Vérifier la synchronisation du cluster filesystem
      ansible.builtin.stat:
        path: /etc/pve/nodes
      register: cluster_nodes_dir

    - name: Lister les nœuds dans /etc/pve/nodes
      ansible.builtin.command: ls -la /etc/pve/nodes/
      register: pve_nodes_content
      changed_when: false

    - name: Afficher les nœuds synchronisés
      ansible.builtin.debug:
        msg: "{{ pve_nodes_content.stdout_lines }}"

    - name: S'assurer que les services cluster sont activés
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - corosync
        - pve-cluster
        - pvedaemon
        - pveproxy

    - name: Afficher message de succès final
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "✓ CLUSTER PROXMOX VE CREE AVEC SUCCES"
          - "============================================"
          - "Nom du cluster: {{ cluster_name }}"
          - "Nœud actuel: {{ inventory_hostname }}"
          - "Accès Web: https://{{ ansible_host }}:8006"
          - "============================================"
          - ""
          - "Prochaines étapes:"
          - "1. Se connecter à l'interface web"
          - "2. Vérifier le statut du cluster"
          - "3. Configurer le stockage partagé (optionnel)"
          - "4. Configurer la haute disponibilité (optionnel)"
          - "============================================"
      run_once: true

    - name: Phase 6 terminée
      ansible.builtin.debug:
        msg: "✓ Phase 6 terminée - Toutes les vérifications OK"
