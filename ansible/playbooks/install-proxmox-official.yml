---
# ============================================
# PLAYBOOK: INSTALLATION PROXMOX VE
# Utilise les commandes officielles Proxmox
# Documentation: https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_12_Bookworm
# ============================================

- name: "Installation Proxmox VE - Méthode Officielle"
  hosts: proxmox_install
  gather_facts: true

  tasks:
    - name: Afficher les informations du serveur
      ansible.builtin.debug:
        msg:
          - "==================================="
          - "Installation Proxmox VE"
          - "==================================="
          - "Serveur: {{ inventory_hostname }}"
          - "IP: {{ ansible_host }}"
          - "Hostname: {{ hostname }}"
          - "OS: Debian {{ ansible_distribution_major_version }}.{{ ansible_distribution_minor_version }}"
          - "==================================="

    - name: Vérifier que le système est Debian 12
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Debian"
          - ansible_distribution_major_version == "12"
        fail_msg: "Ce playbook nécessite Debian 12 (Bookworm)"
        success_msg: "Système compatible: Debian {{ ansible_distribution_version }}"

    - name: Configurer le hostname
      ansible.builtin.hostname:
        name: "{{ hostname }}"

    - name: Configurer /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "{{ ansible_host }} {{ hostname.split('.')[0] }}.localdomain {{ hostname.split('.')[0] }}"
        create: yes

    - name: Sauvegarder la configuration réseau cloud-init
      ansible.builtin.copy:
        src: /etc/network/interfaces.d/50-cloud-init
        dest: /root/50-cloud-init.backup
        remote_src: yes
      ignore_errors: yes

    - name: Nettoyer configuration cloud-init (problème ifupdown2 sur Hetzner)
      ansible.builtin.copy:
        content: |
          # Configuration réseau simplifiée pour compatibilité Proxmox/ifupdown2
          # IPv6 statique, DNS et gateway retirés (incompatibles avec ifupdown2)
          auto lo
          iface lo inet loopback

          auto eth0
          iface eth0 inet dhcp
        dest: /etc/network/interfaces.d/50-cloud-init
        mode: '0644'

    - name: Ajouter le dépôt Proxmox VE
      ansible.builtin.copy:
        content: "deb [arch=amd64] http://download.proxmox.com/debian/pve bookworm pve-no-subscription\n"
        dest: /etc/apt/sources.list.d/pve-install-repo.list
        mode: '0644'

    - name: Télécharger la clé GPG Proxmox
      ansible.builtin.get_url:
        url: https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg
        dest: /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
        mode: '0644'

    - name: Mettre à jour le système
      ansible.builtin.apt:
        update_cache: yes
        upgrade: full
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Installer le kernel Proxmox
      ansible.builtin.apt:
        name: proxmox-default-kernel
        state: present
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Redémarrer pour charger le kernel Proxmox
      ansible.builtin.reboot:
        msg: "Redémarrage pour charger le kernel Proxmox"
        reboot_timeout: 300

    - name: Attendre que le serveur soit de retour
      ansible.builtin.wait_for_connection:
        delay: 10
        timeout: 300

    - name: Installer Proxmox VE et dépendances
      ansible.builtin.apt:
        name:
          - proxmox-ve
          - postfix
          - open-iscsi
          - chrony
        state: present
      environment:
        DEBIAN_FRONTEND: noninteractive
        POSTFIX_CONFIG: "Local only"
      register: proxmox_install

    - name: Afficher résultat installation
      ansible.builtin.debug:
        msg:
          - "✓ Installation Proxmox VE terminée"
          - "Interface web: https://{{ ansible_host }}:8006"
          - "Login: root"
          - "Un redémarrage est recommandé"

    - name: Créer fichier de statut
      ansible.builtin.copy:
        content: |
          Installation Proxmox VE
          Date: {{ ansible_date_time.iso8601 }}
          Hostname: {{ hostname }}
          IP: {{ ansible_host }}
          Méthode: Script officiel Proxmox
        dest: /root/proxmox-installation-status.txt
        mode: '0644'
